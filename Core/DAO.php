<?php


namespace Core;

use Doctrine\ORM\EntityManager;

/**
 * Initializes DoctrineORM
 */
require_once __DIR__ . "/../bootstrap.php";

/**
 * Class DAO.
 * Helper functions
 * @package Core
 */
abstract class DAO
{
    public static $PAGINATION_SIZE = 5;
    /**
     * Doctrine entity manager
     * @var
     */
    private static $entityManager;

    public static function getCount($entityName)
    {
        $em = self::getEntityManager();
        $repo = $em->getRepository($entityName);
        return $repo->createQueryBuilder('a')
            // Filter by some parameter if you want
            // ->where('a.published = 1')
            ->select('count(a.id)')
            ->getQuery()
            ->getSingleScalarResult();

    }

    /**
     * @return EntityManager
     */
    public static function getEntityManager()
    {
        if (self::$entityManager == null) {
            self::$entityManager = getEntityManager();
        }
        return self::$entityManager;
    }

    public static function getLastId($entityName)
    {
        $em = self::getEntityManager();
        $repo = $em->getRepository($entityName);
        return $repo->findOneBy([], ['id' => 'desc'])->getId();
    }

    public static function getNextAutoIncrement($database, $table)
    {
        $em = self::getEntityManager();
        $conn = $em->getConnection();
        $sql = "SELECT `AUTO_INCREMENT`
                FROM  INFORMATION_SCHEMA.TABLES
                WHERE TABLE_SCHEMA = ?
                AND   TABLE_NAME   = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bindValue(1, $database);
        $stmt->bindValue(2, $table);
        $stmt->execute();
        return $stmt->fetchAssociative()['AUTO_INCREMENT'];
    }

    public static function getEntityById($entity, $id){
        $em = self::getEntityManager();
        $repo = $em->getRepository($entity);
        return $repo->find($id);
    }

    public static function getEntityByPage($entity, $page){
        $startCount = ($page - 1) * self::$PAGINATION_SIZE;

        $dql = "select u from $entity u";
        return self::getEntityManager()->createQuery($dql)
            ->setFirstResult($startCount)
            ->setMaxResults(self::$PAGINATION_SIZE)
            ->getResult();
    }
}