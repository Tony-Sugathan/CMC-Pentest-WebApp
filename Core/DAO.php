<?php


namespace Core;

/**
 * Initializes DoctrineORM
 */
require_once __DIR__."/../bootstrap.php";
/**
 * Class DAO.
 * Helper functions
 * @package Core
 */
abstract class DAO
{
    /**
     * Doctrine entity manager
     * @var
     */
    private static $entityManager;

    /**
     * @return \Doctrine\ORM\EntityManager
     */
    public static function getEntityManager(){
        if(self::$entityManager == null){
            self::$entityManager = getEntityManager();
        }
        return self::$entityManager;
    }

    public static function getCount($entityName){
        $em = self::getEntityManager();
        $repo = $em->getRepository($entityName);
        return $repo->createQueryBuilder('a')
            // Filter by some parameter if you want
            // ->where('a.published = 1')
            ->select('count(a.id)')
            ->getQuery()
            ->getSingleScalarResult();

    }

    public static function getLastId($entityName){
        $em = self::getEntityManager();
        $repo = $em->getRepository($entityName);
        return $repo->findOneBy([],['id'=>'desc'])->getId();
    }

    public static function getNextAutoIncrement($database, $table){
        $em = self::getEntityManager();
        $conn = $em->getConnection();
        $sql = "SELECT `AUTO_INCREMENT`
                FROM  INFORMATION_SCHEMA.TABLES
                WHERE TABLE_SCHEMA = ?
                AND   TABLE_NAME   = ?";
        $stmt = $conn->prepare($sql);
        $stmt->bindValue(1, $database);
        $stmt->bindValue(2, $table);
        $stmt->execute();
        return $stmt->fetchAssociative()['AUTO_INCREMENT'];
    }
}