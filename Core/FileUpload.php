<?php


namespace Core;


abstract class FileUpload
{
    public static $DEFAULT_SIZE_LIMIT = 500000;
    public static $IMAGE_TYPES = ['jpg', 'jpeg', 'png', 'gif'];
    public static $ITEMS_IMAGE_PATH = "/public/img/items/";
    public static $USERS_IMAGE_PATH = "/public/img/users/";
    private static $error = [];

    /**
     * @param $file : the file specified, called by $_FILES["inputname"]
     * https://www.php.net/manual/en/features.file-upload.post-method.php
     * @param string $filename: no extension (1 2 3 4 etc)
     * @param string $path
     * @param string[] $acceptedTypes
     * @param int $sizeLimit
     * @return bool
     */
    public static function uploadImage($file, $filename = '', $path = '/public/img/items/', $acceptedTypes = ['jpg', 'jpeg', 'png', 'gif'], $sizeLimit = 500000)
    {
        $imageFileType = strtolower(pathinfo($path . basename($file['name']), PATHINFO_EXTENSION));
        $filename = empty($filename) ? basename($file['name']) : $filename . "." . $imageFileType;
        $target_file = $path . $filename;
        $uploadOk = 1;
        // Check if image file is a actual image or fake image
        if (isset($_POST["submit"])) {
            $check = getimagesize($file["tmp_name"]);
            if ($check !== false) {
//                echo "File is an image - " . $check["mime"] . ".";
                $uploadOk = 1;
            } else {
                Flash::addMessage("File is not an image.");
                $uploadOk = 0;
            }
        }

        // Check if file already exists
//        if (file_exists($target_file)) {
//            self::$error[] = "Sorry, file already exists.";
//            $uploadOk = 0;
//        }

        // Check file size
        if ($file["size"] > $sizeLimit) {
            Flash::addMessage("Sorry, your file is too large.");
            $uploadOk = 0;
        }

        // Allow certain file formats
        if (!in_array($imageFileType, $acceptedTypes)) {
            Flash::addMessage("Sorry, only " . join(', ', $acceptedTypes) . " files are allowed. Your file's type is $imageFileType.");
            $uploadOk = 0;
        }

        // Check if $uploadOk is set to 0 by an error
        if ($uploadOk == 0) {
            Flash::addMessage("Sorry, there was an error uploading your file.");
            // if everything is ok, try to upload file
        } else {
            if (move_uploaded_file($file["tmp_name"], dirname(__DIR__) . $target_file)) {
                return preg_replace('/^\/public/', '', $target_file);
            } else {
                Flash::addMessage("Sorry, there was an error uploading your file.");
            }
        }
    }

    /**
     * @return array
     */
    public static function getError(): array
    {
        return self::$error;
    }

    public static function deleteFile()
    {
        //TODO
    }

}