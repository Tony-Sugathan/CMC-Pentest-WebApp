<?php


namespace App\Controllers;


use App\Models\Users;
use Core\DAO;
use Core\FileUpload;
use Core\Flash;
use Core\Helper;
use Core\View;
use http\Client\Curl\User;

class Profile extends \Core\Controller
{ //TODO
    public function indexAction(){
        $userId = $this->route_params['id']??$_SESSION['user_id'];

        $user = Users::getById($userId);
        if(!$user){
            //doesn't exists, display error
            View::renderTemplate('404.twig');
        }else{
            View::renderTemplate('Profile/profile-details.twig', ['user'=>$user]);
        }
    }

    public function editAction(){
        //always edit own profile
        $user = Users::getCurrentUser();
        if(isset($_POST['fullname']) && !empty($_POST['fullname'])){
            $fullname = Helper::test_input($_POST['fullname']);
            $user->setFullName($fullname);
        }

        if(isset($_POST['email']) && !empty($_POST['email'])){
            $email = Helper::test_input($_POST["email"]);
            //test valid email
            if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
                Flash::addMessage("Invalid email format.", Flash::WARNING);
            }
            //find dups
            if(Users::getByEmail($email)){
                Flash::addMessage("Email already taken.", Flash::WARNING);
            }

            $user->setEmail($email);
        }

        if($_FILES['image']['size'] != 0){
            //image changed
            $image = FileUpload::uploadImage($_FILES['image'], $user->getId(), FileUpload::$USERS_IMAGE_PATH);
            $user->setImagePath($image);
        }

        DAO::getEntityManager()->flush();
//        Flash::addMessage("Email already taken.", Flash::WARNING);
        $this->redirect("/profile");
    }


    public function changePasswordAction(){
        //display change password page
    }

    public function doChangePasswordAction(){
        $user = Users::getCurrentUser();
        //check and update DB
    }

    protected function before()
    {
        parent::before();
        $this->requireLogin();
    }


}