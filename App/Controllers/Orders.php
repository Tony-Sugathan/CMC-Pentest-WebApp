<?php


namespace App\Controllers;


use App\Models\Users;
use Core\DAO;
use Core\View;

class Orders extends \Core\Controller
{
    public function indexAction(){
        //display orders history or orders details
        $em = DAO::getEntityManager();
        $orderRepo = $em->getRepository("App\Models\Orders");
        $orderItemRepo = $em->getRepository("App\Models\OrdersItems");
        if(isset($this->route_params['id'])){
            $orderId = $this->route_params['id'];
            $order = $orderRepo->find($orderId);
            if($order->getUser()->getId() != $_SESSION['user_id']){
                View::renderTemplate('404.twig');
                exit();
            }
            $orderItems = $orderItemRepo->findBy(['order'=>$order]);
            View::renderTemplate('Orders/orderDetails.twig', ['order'=>$order, 'items'=>$orderItems]);
        }else{
            $orders = $orderRepo->findBy(['user'=>Users::getCurrentUser()]);
            View::renderTemplate('Orders/index.twig', ['orders'=>$orders]);
        }

    }

    protected function before()
    {
        parent::before(); // TODO: Change the autogenerated stub
        $this->requireLogin();
    }


}