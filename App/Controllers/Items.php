<?php


namespace App\Controllers;
use Core\Auth;
use Core\DAO;
use Core\View;

class Items extends \Core\Controller
{
    public function indexAction(){
        if(isset($this->route_params['id'])){
            $id = $this->route_params['id'];

            $item = DAO::getEntityManager()->find(':Items', $id);
            View::renderTemplate("Items/item-details.twig", ["item"=>$item, "route_params" => $this->route_params]);
        }else{
//            $itemRepo = DAO::getEntityManager()->getRepository(':Items');
//
//            $items = $itemRepo->findAll();
//            View::renderTemplate("Items/items.twig", ["items"=>$items]);

            //remember this page to return after adding to cart
            Auth::rememberRequestedPage();
            //pagination
            $pagination = [];
            $page = 1;
            if(isset($_GET['page']) && $_GET['page'] > 1){
                $page = $_GET['page'];
            }

            $itemCount = DAO::getCount(":Items");

            $pagination['page'] = $page;

            $maxPage = ceil($itemCount / DAO::$PAGINATION_SIZE);
            if($page < $maxPage - 1){
                $pagination['maxPage'] = $maxPage;
            }

            $previousPage = $page == 1?null:$page-1;
            if($previousPage){
                $pagination['previousPage'] = $previousPage;
            }

            $nextPage = $page == $maxPage?null:$page+1;
            $pagination['nextPage'] = $nextPage;

            $items = \App\Models\Items::getItemsByPage($page);
            View::renderTemplate("Items/items.twig", ["items"=>$items, 'pagination'=>$pagination]);
        }
    }


}